services:
  # --- AI mode: SmartBots bridge plugin + Python AI brain ---
  insurgency:
    build:
      context: ./insurgency-server
      dockerfile: Dockerfile
    container_name: insurgency-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
      - ./insurgency-server/plugins:/home/steam/insurgency-server/insurgency/addons/sourcemod/plugins/custom:ro
      - ./insurgency-server/gamedata/smartbots_bridge.txt:/home/steam/insurgency-server/insurgency/addons/sourcemod/gamedata/smartbots_bridge.txt:ro
      - ./ai-brain/data:/home/steam/insurgency-server/insurgency/addons/sourcemod/data/smartbots
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Dev Server
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - ai

  ai-brain:
    build:
      context: ./ai-brain
      dockerfile: Dockerfile
    container_name: insurgency-ai
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/server-files/insurgency/maps:/app/maps:ro
      - ./ai-brain/data:/app/data
      - ./ai-brain/src:/app/src:ro
    environment:
      - AI_LISTEN_HOST=0.0.0.0
      - AI_LISTEN_PORT=9000
      - NAV_MAP=${NAV_MAP:-ministry_coop}
      - RECORD_POSITIONS=${RECORD_POSITIONS:-0}
      - SPATIAL_DATA_DIR=/app/data
      - TELEMETRY=${TELEMETRY:-0}
      - TELEMETRY_HOST=localhost
      - TELEMETRY_PORT=5432
    profiles:
      - ai

  telemetry-db:
    image: postgres:17-alpine
    container_name: telemetry-db
    restart: unless-stopped
    network_mode: host
    tmpfs:
      - /var/lib/postgresql/data
    environment:
      - POSTGRES_DB=telemetry
      - POSTGRES_USER=smartbots
      - POSTGRES_PASSWORD=smartbots
      - POSTGRES_HOST_AUTH_METHOD=trust
    command: >
      postgres
      -c shared_buffers=32MB
      -c work_mem=4MB
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
    profiles:
      - ai

  # --- Vanilla debug mode: original bot AI + nb_debug logging ---
  insurgency-vanilla:
    build:
      context: ./insurgency-server
      dockerfile: Dockerfile
    container_name: insurgency-vanilla
    restart: unless-stopped
    network_mode: host
    entrypoint: /home/steam/entrypoint-vanilla.sh
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
    environment:
      - START_MAP=${START_MAP:-ministry_coop}
      - MAX_PLAYERS=32
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - vanilla

  # --- Record mode: observer-only plugin + original AI + position recording ---
  insurgency-record:
    build:
      context: ./insurgency-server
      dockerfile: Dockerfile
    container_name: insurgency-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
      - ./insurgency-server/plugins/smartbots_observer.smx:/home/steam/insurgency-server/insurgency/addons/sourcemod/plugins/custom/smartbots_observer.smx:ro
      - ./ai-brain/data:/home/steam/insurgency-server/insurgency/addons/sourcemod/data/smartbots
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Recorder
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - record

  ai-record:
    build:
      context: ./ai-brain
      dockerfile: Dockerfile
    container_name: insurgency-ai-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/server-files/insurgency/maps:/app/maps:ro
      - ./ai-brain/data:/app/data
      - ./ai-brain/src:/app/src:ro
    environment:
      - AI_LISTEN_HOST=0.0.0.0
      - AI_LISTEN_PORT=9000
      - NAV_MAP=${NAV_MAP:-ministry_coop}
      - RECORD_POSITIONS=1
      - SPATIAL_DATA_DIR=/app/data
    profiles:
      - record
