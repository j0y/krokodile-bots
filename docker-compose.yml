services:
  # --- AI mode: Metamod extension + Python tactical planner ---
  insurgency:
    build:
      context: .
      dockerfile: insurgency-server/Dockerfile
    container_name: insurgency-server
    restart: unless-stopped
    ports:
      - "27025:27025/udp"
      - "27025:27025/tcp"
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
    environment:
      - SERVER_HOSTNAME=${SERVER_HOSTNAME:-Insurgency Smart Bots Dev Server}
      - SERVER_PASSWORD=${SERVER_PASSWORD:-}
      - RCON_PASSWORD=${RCON_PASSWORD:-changeme}
      - MAX_PLAYERS=${MAX_PLAYERS:-32}
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=${GAME_MODE:-checkpoint}
      - TICKRATE=${TICKRATE:-64}
      - NB_DEBUG=${NB_DEBUG:-0}
      - HARD_BOTS=${HARD_BOTS:-0}
      - CONTROLLED_TEAM=${CONTROLLED_TEAM:-3}
      - AI_HOST=tactical-brain
    stdin_open: true
    tty: true
    profiles:
      - ai
      - prod

  tactical-brain:
    build:
      context: ./tactical-brain
      dockerfile: Dockerfile
    container_name: tactical-brain
    restart: unless-stopped
    volumes:
      - ./data:/app/data:ro
    environment:
      - LISTEN_HOST=0.0.0.0
      - LISTEN_PORT=9000
      - DATA_DIR=/app/data
      - CONTROLLED_TEAM=3  # Security: 2, Insurgents: 3
      - TELEMETRY=1
      - TELEMETRY_HOST=telemetry-db
      - TELEMETRY_PORT=5432
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-}
    profiles:
      - ai
      - prod

  telemetry-db:
    image: postgres:17-alpine
    container_name: telemetry-db
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      - POSTGRES_USER=smartbots
      - POSTGRES_PASSWORD=smartbots
      - POSTGRES_DB=telemetry
    tmpfs:
      - /var/lib/postgresql/data
    command: >
      postgres
        -c fsync=off
        -c synchronous_commit=off
        -c full_page_writes=off
    profiles:
      - ai

  # --- Prod mode: same as ai but with persistent telemetry ---
  telemetry-db-prod:
    image: postgres:17-alpine
    container_name: telemetry-db
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      - POSTGRES_USER=smartbots
      - POSTGRES_PASSWORD=smartbots
      - POSTGRES_DB=telemetry
    volumes:
      - telemetry-data:/var/lib/postgresql/data
    command: >
      postgres
        -c synchronous_commit=off
        -c full_page_writes=off
    profiles:
      - prod

  # --- Vanilla debug mode: original bot AI + nb_debug logging ---
  insurgency-vanilla:
    build:
      context: .
      dockerfile: insurgency-server/Dockerfile
    container_name: insurgency-vanilla
    restart: unless-stopped
    ports:
      - "27025:27025/udp"
      - "27025:27025/tcp"
    entrypoint: /home/steam/entrypoint-vanilla.sh
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
    environment:
      - START_MAP=${START_MAP:-ministry_coop}
      - MAX_PLAYERS=${MAX_PLAYERS:-32}
      - TICKRATE=${TICKRATE:-64}
    stdin_open: true
    tty: true
    profiles:
      - vanilla

volumes:
  telemetry-data:
