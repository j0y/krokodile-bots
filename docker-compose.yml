services:
  # --- AI mode: SmartBots bridge plugin + Python AI brain ---
  insurgency:
    build:
      context: ./insurgency-server
      dockerfile: Dockerfile
    container_name: insurgency-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
      - ./insurgency-server/plugins:/home/steam/insurgency-server/insurgency/addons/sourcemod/plugins/custom:ro
      - ./insurgency-server/gamedata/smartbots_bridge.txt:/home/steam/insurgency-server/insurgency/addons/sourcemod/gamedata/smartbots_bridge.txt:ro
      - ./ai-brain/data:/home/steam/insurgency-server/insurgency/addons/sourcemod/data/smartbots
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Dev Server
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - ai

  ai-brain:
    build:
      context: ./ai-brain
      dockerfile: Dockerfile
    container_name: insurgency-ai
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/server-files/insurgency/maps:/app/maps:ro
      - ./ai-brain/data:/app/data
    environment:
      - AI_LISTEN_HOST=0.0.0.0
      - AI_LISTEN_PORT=9000
      - NAV_MAP=${NAV_MAP:-ministry_coop}
      - RECORD_POSITIONS=${RECORD_POSITIONS:-0}
      - SPATIAL_DATA_DIR=/app/data
    depends_on:
      - insurgency
    profiles:
      - ai

  # --- Record mode: observer-only plugin + original AI + position recording ---
  insurgency-record:
    build:
      context: ./insurgency-server
      dockerfile: Dockerfile
    container_name: insurgency-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
      - ./insurgency-server/plugins/smartbots_observer.smx:/home/steam/insurgency-server/insurgency/addons/sourcemod/plugins/custom/smartbots_observer.smx:ro
      - ./ai-brain/data:/home/steam/insurgency-server/insurgency/addons/sourcemod/data/smartbots
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Recorder
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - record

  ai-record:
    build:
      context: ./ai-brain
      dockerfile: Dockerfile
    container_name: insurgency-ai-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/server-files/insurgency/maps:/app/maps:ro
      - ./ai-brain/data:/app/data
    environment:
      - AI_LISTEN_HOST=0.0.0.0
      - AI_LISTEN_PORT=9000
      - NAV_MAP=${NAV_MAP:-ministry_coop}
      - RECORD_POSITIONS=1
      - SPATIAL_DATA_DIR=/app/data
    depends_on:
      - insurgency-record
    profiles:
      - record
