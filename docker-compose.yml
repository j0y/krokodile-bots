services:
  # --- AI mode: Metamod extension + Python tactical planner ---
  insurgency:
    build:
      context: .
      dockerfile: insurgency-server/Dockerfile
    container_name: insurgency-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Dev Server
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - ai

  tactical-brain:
    build:
      context: ./tactical-brain
      dockerfile: Dockerfile
    container_name: tactical-brain
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./ai-brain-old/data:/app/data:ro
    environment:
      - LISTEN_HOST=0.0.0.0
      - LISTEN_PORT=9000
      - RALLY_X=3500
      - RALLY_Y=-1500
      - RALLY_Z=32
      - MAP_NAME=${START_MAP:-ministry_coop}
      - DATA_DIR=/app/data
      - TELEMETRY=1
      - TELEMETRY_HOST=localhost
      - TELEMETRY_PORT=5432
    profiles:
      - ai

  telemetry-db:
    image: postgres:17-alpine
    container_name: telemetry-db
    restart: unless-stopped
    network_mode: host
    environment:
      - POSTGRES_USER=smartbots
      - POSTGRES_PASSWORD=smartbots
      - POSTGRES_DB=telemetry
    tmpfs:
      - /var/lib/postgresql/data
    command: >
      postgres
        -c fsync=off
        -c synchronous_commit=off
        -c full_page_writes=off
    profiles:
      - ai

  # --- Vanilla debug mode: original bot AI + nb_debug logging ---
  insurgency-vanilla:
    build:
      context: .
      dockerfile: insurgency-server/Dockerfile
    container_name: insurgency-vanilla
    restart: unless-stopped
    network_mode: host
    entrypoint: /home/steam/entrypoint-vanilla.sh
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
    environment:
      - START_MAP=${START_MAP:-ministry_coop}
      - MAX_PLAYERS=32
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - vanilla

  # --- Record mode: observer-only plugin + original AI + position recording ---
  insurgency-record:
    build:
      context: .
      dockerfile: insurgency-server/Dockerfile
    container_name: insurgency-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/cfg:/home/steam/insurgency-server/insurgency/cfg/custom:ro
      - ./ai-brain-old/reference/smartbots_observer.smx:/home/steam/insurgency-server/insurgency/addons/sourcemod/plugins/custom/smartbots_observer.smx:ro
      - ./ai-brain-old/data:/home/steam/insurgency-server/insurgency/addons/sourcemod/data/smartbots
    environment:
      - SERVER_HOSTNAME=Insurgency Smart Bots Recorder
      - SERVER_PASSWORD=
      - RCON_PASSWORD=changeme
      - MAX_PLAYERS=32
      - START_MAP=${START_MAP:-ministry_coop}
      - GAME_MODE=coop
      - TICKRATE=64
    stdin_open: true
    tty: true
    profiles:
      - record

  ai-record:
    build:
      context: ./ai-brain
      dockerfile: Dockerfile
    container_name: insurgency-ai-record
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./insurgency-server/server-files/insurgency/maps:/app/maps:ro
      - ./ai-brain-old/data:/app/data
      - ./ai-brain-old/src:/app/src:ro
    environment:
      - AI_LISTEN_HOST=0.0.0.0
      - AI_LISTEN_PORT=9000
      - NAV_MAP=${NAV_MAP:-ministry_coop}
      - RECORD_POSITIONS=1
      - SPATIAL_DATA_DIR=/app/data
    profiles:
      - record
